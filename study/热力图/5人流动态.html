<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>自动流动热力图</title>
</head>

<body>
    <script>
        const canvas = document.createElement('canvas');
        canvas.width = 600;
        canvas.height = 400;
        canvas.style.border = '1px solid #000';
        document.body.appendChild(canvas);
        const ctx = canvas.getContext('2d');

        // 渐变色条
        const gradCanvas = document.createElement('canvas');
        gradCanvas.width = 256; gradCanvas.height = 1;
        const gctx = gradCanvas.getContext('2d');
        const gradient = gctx.createLinearGradient(0, 0, 256, 0);
        gradient.addColorStop(0, "blue");
        gradient.addColorStop(0.25, "cyan");
        gradient.addColorStop(0.5, "green");
        gradient.addColorStop(0.75, "yellow");
        gradient.addColorStop(1, "red");
        gctx.fillStyle = gradient;
        gctx.fillRect(0, 0, 256, 1);
        const colorData = gctx.getImageData(0, 0, 256, 1).data;

        // 高斯圆生成
        function createGaussianCircle(radius) {
            const size = radius * 2;
            const c = document.createElement('canvas');
            c.width = c.height = size;
            const cctx = c.getContext('2d');
            const grad = cctx.createRadialGradient(radius, radius, 0, radius, radius, radius);
            grad.addColorStop(0, 'rgba(0,0,0,1)');
            grad.addColorStop(1, 'rgba(0,0,0,0)');
            cctx.fillStyle = grad;
            cctx.fillRect(0, 0, size, size);
            return c;
        }

        // 点数组
        let points = [];

        // 自动生成随机点
        function generateRandomPoints(count = 2) {
            for (let i = 0; i < count; i++) {
                points.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    value: Math.random() * 0.5 + 0.5,  // 权重0.5~1
                    currentRadius: 0,
                    maxRadius: 50 + Math.random() * 20,  // 最大半径随机
                    alpha: 1
                });
            }
        }

        // 绘制灰度热力图
        function drawGrayHeatmap() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.globalCompositeOperation = 'lighter';
            points.forEach(p => {
                if (p.alpha <= 0) return;
                const radius = Math.floor(p.currentRadius);
                const circle = createGaussianCircle(radius);
                ctx.globalAlpha = 0.3 * p.value * p.alpha;
                ctx.drawImage(circle, p.x - radius, p.y - radius);
            });
        }

        // alpha 转颜色
        function applyColorGradient() {
            const img = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = img.data;
            for (let i = 0; i < data.length; i += 4) {
                const alpha = data[i + 3];
                if (alpha > 0) {
                    const idx = Math.min(Math.floor(alpha / 255 * 255), 255) * 4;
                    data[i] = colorData[idx];
                    data[i + 1] = colorData[idx + 1];
                    data[i + 2] = colorData[idx + 2];
                    data[i + 3] = alpha;
                }
            }
            ctx.putImageData(img, 0, 0);
        }

        // 动画循环
        function animate() {
            // 每帧生成随机新点
            generateRandomPoints(2);

            // 更新点状态
            for (let i = points.length - 1; i >= 0; i--) {
                const p = points[i];
                p.currentRadius += 1;     // 扩散速度
                p.alpha -= 0.01;          // 衰减速度
                if (p.alpha <= 0) points.splice(i, 1);
            }

            drawGrayHeatmap();
            applyColorGradient();
            requestAnimationFrame(animate);
        }

        animate();
    </script>
</body>

</html>