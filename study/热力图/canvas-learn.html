<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>åŠ¨æ€åˆ›å»º Canvas</title>
</head>

<body>
  <script>
    // 1ï¸âƒ£ åˆ›å»º canvas
    const canvas = document.createElement('canvas');
    canvas.width = 400;
    canvas.height = 300;
    canvas.style.border = "1px solid #000";

    // 2ï¸âƒ£ æ’å…¥åˆ°é¡µé¢
    document.body.appendChild(canvas);

    // 3ï¸âƒ£ è·å–ç»˜å›¾ä¸Šä¸‹æ–‡
    const ctx = canvas.getContext('2d');

    // 4ï¸âƒ£ æµ‹è¯•ç‚¹æ•°æ®
    const points = [
      { x: 50, y: 50, value: 1 },
      { x: 200, y: 100, value: 2 },
      { x: 300, y: 200, value: 3 }
    ];

    console.log("ç‚¹æ•°æ®å‡†å¤‡å¥½äº†", points);

    // 5ï¸âƒ£ ç®€å•ç»˜åˆ¶ç‚¹ï¼Œç¡®è®¤ä½ç½®
    /* points.forEach(p => {
      ctx.fillStyle = "red";
      ctx.beginPath();
      ctx.arc(p.x, p.y, 5, 0, Math.PI * 2);
      ctx.fill();
    }) */

    // åˆ›å»ºäºŒç»´æ•°ç»„ï¼Œåˆå§‹åŒ–ä¸º 0
    const width = canvas.width
    const height = canvas.height
    // æŠŠç”»å¸ƒåˆ’åˆ†300è¡Œ400åˆ— 
    const density = Array.from({ length: height }, () => Array(width).fill(0));

    // æŠŠç‚¹æ˜ å°„åˆ°çŸ©é˜µ 
    points.forEach(p => {
      const x = Math.floor(p.x)
      const y = Math.floor(p.y)
      // ç¡®ä¿ç‚¹åœ¨ç”»å¸ƒèŒƒå›´å†…
      if (x >= 0 && x < width && y >= 0 && y < height) {
        density[y][x] += p.value; // åœ¨å¯¹åº”åƒç´ ä½ç½®åŠ ä¸Šæƒé‡
      }
    })
    console.log("å¯†åº¦çŸ©é˜µ", density);

    function addPointWithGaussian(density, px, py, value, radius = 30, sigma = 10) {
      const height = density.length;
      const width = density[0].length;

      // éå†å‘¨å›´åƒç´ 
      for (let y = py - radius; y <= py + radius; y++) {
        for (let x = px - radius; x <= px + radius; x++) {
          if (x >= 0 && x < width && y >= 0 && y < height) {
            const dx = x - px;
            const dy = y - py;
            const d2 = dx * dx + dy * dy;

            // é«˜æ–¯å‡½æ•°è®¡ç®—æƒé‡
            const weight = Math.exp(-d2 / (2 * sigma * sigma));

            // æŠŠè¿™ä¸ªç‚¹çš„å½±å“åŠ åˆ°å¯†åº¦çŸ©é˜µé‡Œ
            density[y][x] += value * weight;
            console.log('å½±å“', density[y][x]);

          }
        }
      }
    }

    // ä½¿ç”¨ç¤ºä¾‹ï¼Œ é«˜æ–¯æ‰©æ•£ç‚¹çš„å½±å“
    points.forEach(p => {
      addPointWithGaussian(density, Math.floor(p.x), Math.floor(p.y), p.value);
    })

    /*  1ï¸âƒ£ å½’ä¸€åŒ–
  çƒ­åº¦å€¼å¤§å°ä¸ä¸€ï¼Œæˆ‘ä»¬è¦å…ˆæŠŠå®ƒæ˜ å°„åˆ° [0,1] åŒºé—´ */
    // æ‰¾æœ€å¤§å€¼
    let maxDensity = 0;
    for (let y = 0; y < height; y++) {
      for (let x = 0; x < width; x++) {
        if (density[y][x] > maxDensity) {
          maxDensity = density[y][x];
        }
      }
    }

    /* 2ï¸âƒ£ å®šä¹‰é¢œè‰²æ˜ å°„å‡½æ•°
    æˆ‘ä»¬å¯ä»¥å…ˆç”¨ç®€å•çš„ â€œè“ â†’ é’ â†’ ç»¿ â†’ é»„ â†’ çº¢â€ æ¸å˜ */
    // ğŸ‘‰ ä»¥åæˆ‘ä»¬å¯ä»¥ç”¨æ›´æ¼‚äº®çš„æ¸å˜è‰²è¡¨ï¼ˆæ¯”å¦‚ d3-scaleï¼‰ï¼Œä½†ç°åœ¨å…ˆç”¨ç®€å•ç‰ˆã€‚
    function getColor(value) {
      // value âˆˆ [0,1]
      const r = Math.floor(255 * value);         // è¶Šçƒ­è¶Šçº¢
      const g = Math.floor(255 * (1 - value));   // å†·çš„æ—¶å€™åç»¿
      const b = Math.floor(255 * (1 - value));   // å†·çš„æ—¶å€™åè“
      const a = value > 0 ? 0.6 : 0;             // æœ‰çƒ­åº¦æ‰æ˜¾ç¤º
      return `rgba(${r},${g},${b},${a})`;
    }

    /* 3ï¸âƒ£ éå†çŸ©é˜µç»˜åˆ¶åƒç´ 
ç”¨ fillRect ç»™æ¯ä¸ªåƒç´ ç€è‰²ï¼š */
    for (let y = 0; y < height; y++) {
      for (let x = 0; x < width; x++) {
        const value = density[y][x] / maxDensity; // å½’ä¸€åŒ–
        ctx.fillStyle = getColor(value);
        ctx.fillRect(x, y, 1, 1); // ç”» 1 åƒç´ 
      }
    }

  </script>
</body>

</html>